<html style="background-color: #0a0f14">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
  <title>Mixmax &middot; Diff</title>

  <!-- Mixmax SDK -->
  <script defer src="https://d1xa36cy0xt122.cloudfront.net/v1/Mixmax.js"></script>

  <link rel="stylesheet" href="/styles.css">
  <link href='//fonts.googleapis.com/css?family=Merriweather:400,700,400italic,700italic,900,900italic,300italic,300' rel='stylesheet' type='text/css'>
  <script src="//code.jquery.com/jquery-2.1.3.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.2/underscore-min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/backbone.js/1.1.2/backbone-min.js"></script>
  <script src="/lib/masonry.js"></script>

  <script src="/codemirror.js"></script>
  <link rel="stylesheet" href="/codemirror.css">
  <script src="/mode/javascript/javascript.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/diff_match_patch/20121119/diff_match_patch.js"></script>
  <script src="/merge/merge.js"></script>
  <link rel=stylesheet href="/merge/merge.css">
</head>

<body data-current-theme="gmail">

<div class="app-popup app-giphy">
  <div class="toolbar text--reverse toolbar--app  ui-face">
    <div class="toolbar__title text--caps">
      Differ

    </div>
    <div class="flexbox flexbox--column">
      <form class="diff-original">
        <textarea class="diff-original-text flex-fill">Paste your code here.</textarea>
        <button type="submit" class="js-submit-original btn btn--pill pull-right text--caps">submit original</button>
      </form>

      <div hidden class="merge-div">
        <form class="diff-modified">
          <!-- <textarea class="diff-modified-text flex-fill">test2</textarea> -->
          <div class="diff-modified-text"></div>
          <button type="reset" class="js-back btn btn--pill text--caps">back</button>
          <button type="submit" class="js-submit-modified btn btn--pill text--caps pull-right">submit modified</button>
        </form>
      </div>
    <div class="js-diff-container"></div>
  </div>


  </div>
</div>

<script>
  var Differ = Backbone.View.extend({
    _modified: null,
    _original: null,

    events: {
      'click .js-submit-original': '_submit_original',
      'click .js-back': '_back',
      'click .js-submit-modified': '_done',
    },

    render: function() {
      var self = this,
          body = document.body,
          timer;

      var originalArea = $('.diff-original-text')[0];
      this._original = CodeMirror.fromTextArea(originalArea, {
        lineNumbers: true
      });

      var modifiedArea = $('.diff-modified-text')[0];
      this._modified = CodeMirror.MergeView(modifiedArea, {
        'value': '',
        'origLeft': '',
        'lineNumbers': true,
        'collapseIdentical': false,

      });

    },

    _submit_original: function(e) {
      var self = this;
      e.preventDefault();

      this._modified.leftOriginal().setValue(this._original.getValue());
      this._modified.editor().setValue(this._original.getValue());

      $('.diff-original').hide();
      $('.merge-div').show();

      // some weird closure thing
      var that = this;
      setTimeout(function() {
        that._modified.leftOriginal().refresh();
        that._modified.editor().refresh();
      })

    },

    _back: function(e) {
      e.preventDefault();

      $('.merge-div').hide();
      $('.diff-original').show();
    },

    _done: function(e) {
      e.preventDefault();

      var original = this._original.getValue();
      // var diffs = this._modified.left.diff;
      var modified = this._modified.editor().getValue();

      // Let Mixmax know it was done.
      Mixmax.done({
        original: original,
        modified: modified
      });
    },

    _cancel: function() {
      Mixmax.cancel();
    }
  });

  // Create
  new Differ({
    el: document.body
  }).render();

</script>
</body>
</html>
